# План технического задания на разработку системы непрерывной интеграции "Swompi-Runner"

## Введение

* **Наименование проекта:** Разработка системы непрерывной интеграции "Swompi-Runner".
* **Цели и назначение документа:** to-do
* **Область применения:** to-do
* **Термины и определения:** to-do (Пайплайн, Сборка/Билд, Веб-хук, Артефакт, Исполнитель/Executor, .myci.yml).

## Общие сведения о проекте

* **Заказчик:** Чернышев, ГУАП
* **Исполнитель:** Орлова С.Н., Ершова О.А.
* **Основание для разработки:** Курсовой проект по дисциплине «Технологии программирования».

## Требования к системе

### Функциональные требования

#### Общие требования

* Система должна запускать pipeline в ответ на веб-хуки от GitHub.
* Конфигурация pipeline должна считываться из файла .swompi.yml в корне репозитория.
* Каждая сборка должна выполнятся в Docker контейнере.

#### Требования к модулю обработки веб-хуков

* Наличие HTTP-endpoint для приема POST-запросов
* Валидация запросов с использованием секретного ключа.
* Парсинг данных из веб-хука (URL репозитория, хэш коммита).

#### Требования к модулю Исполнителя (Executor)

* Клонирование репозитория по указанному URL и коммиту.
* Чтение и парсинг файла .swompi.yml.
* Создание определенного Docker-контейнера.
* Доступность в контейнере предопределенных переменных (CI_COMMIT_SHA, CI_COMMIT_MESSAGE, CI_COMMIT_AUTHOR, CI_PROJECT_DIR, CI_REPO_URL, CI_BUILD_ID, CI_SERVER_NAME, CI_COMMIT_REF_NAME).
* Доступность в контейнере пользовательских переменных из секции variables.
* Последовательное выполнение команд из секций scripts.
* Захват и объединение stdout и stderr для формирования полного лога сборки в файл.
* Обработка секции artifacts для отправления указанных файлов через ТГ бота.
* Управление жизненным циклом Docker-контейнера.
* Полная очистка временных файлов и директорий после завершения сборки.

#### Требования к системе хранения данных

* Хранение истории всех сборок (статус, время начала/окончания, URL репозитория, хэш коммита, хранение пути к файлам артифактам и логам сборки).
* Хранение списка отслеживаемых репозиториев.

#### Требования к системе хранения файлов

* Хранение артефактов сборки.
* Хранение логов сборки.

#### Требования к интерфейсу Telegram-бота

* Отправка уведомлений о статусе сборок.
* Реализация команды `/history [repository_name]` для получения списка последних 10 сборок.
* Реализация `/status <build_id>` для получения полного лога сборки в виде файла.
* Реализация команды `/artifacts <build_id>` для получения артефактов сборки в виде zip-архива и tar-архива.

#### Требования к интерфейсу CLI-администратора

* Реализация команды `add <repository_URL>` для добавления репозитория в отслеживаемые.
* Реализация команды `rm <repository_URL>` для удаления репозитория
* Реализация команды `list` для просмотра списка всех отслеживаемых репозиториев.

### Нефункциональные требования

* **Требования к надежности:** Система должна корректно обрабатывать ошибки (например, неудачное клонирование репозитория, недоступность Docker-демона) и логировать их.
* **Требования к безопасности:** Доступ к репозиториям должен осуществляться через Deploy Keys (SSH-ключи с правами только на чтение). Веб-хуки должны быть защищены секретным ключом.
* **Требования к производительности:** Система должна обеспечивать своевременную очистку дискового пространства после каждой сборки, чтобы избежать его переполнения.

## Архитектура и стек технологий

### Описание архитектуры

/ to-do вставить диаграмму компонентов

### Стек технологий

* Язык программирования: Python 3.13
* Веб-фреймворк: FastAPI
* СУБД: PostgreSQL
* ORM: SQLAlchemy
* Контейнерезация: Docker
* Оркестрация: Docker Compose
* Файловое хранилище: MinIO

### План развертывания и эксплуатации

* **Требования к окружению:** Linux, Python, Docker, Docker Compose.
* **Процесс установки и запуска:** to-do

